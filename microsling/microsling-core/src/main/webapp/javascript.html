<html>
<head>
  <title>Use of javascript in &micro;sling</title>
  <link rel="stylesheet" href="usling.css"/>
</head>
<body>
  <h1>Use of javascript in &micro;sling</h1>
  
  <div class="note">
    <a href="index.html">back to homepage</a>
  </div>
  
  <h2>Scripting basics</h2>
  <p>
  	Scripts are located based on the <em>sling:resourceType</em> property of nodes (and some other variants, but for
  	now we'll leave it at that).
  </p>
  <p>
  	If you created content with the &micro;sling test content creation form, rendering scripts should be stored
  	in the repository under <em>/sling/scripts/usling/example/</em>. Mount the repository with WebDAV to
  	do that, see the WebDAV link on the <a href="index.html">homepage</a>.
  </p>
  <p>
  	To activate a script, remove or rename any existing templates in there, and store one of the scripts shown
  	below there, using the filenames shown in comments in the scripts below.
  </p>
  <p>
  	Content nodes created with the <a href="content-creation-forms.html">Content creation forms</a>
    should then be displayed in HTML, with a layout defined by the example scripts.
  </p>
  <p>
    Other output formats can be generated, for example by renaming the ESP template 
    to <em>txt.esp</em>, modifying it to output plain text 
    and using a <em>.txt</em> extension in the request. Or xml, or any other extension.
  </p>
  <p>
  	TODO explain selectors, default scripts location, non-GET requests, etc.
  </p>
  
  <h2>ECMAscript Server Pages (ESP)</h2>
  <p>
    <em>ECMAscript Server Pages</em> work much like JSP:
    <ul>
      <li>
      	A template mixes javascript code with litteral text that is copied to the output.
      </li>
      <li>
      	<em>&lt;% ... %&gt;</em> tags enclose code blocks.
      </li>
      <li>
      	<em>&lt;%= ... %&gt;</em> tags include the result of a javascript expression in the output.
      </li>
      <li>
      	Several standard objects are available in javascript to access &micro;sling data
      	(TODO: document these objects - for now see the RhinoJavascriptServlet source code)
      </li>
    </ul>
  </p>
  <h3>ESP template example</h3>
    <pre>
&lt;%-- ESP template example, store this as html.esp --%>
&lt;html>
&lt;body>
&lt;p>This page is generated from an ESP template!&lt;/p>
&lt;h1>&lt;%= resource.getPath() %>&lt;/h1>
&lt;%
  for (var prop in resource.node) {
    %>
      &lt;p>
        &lt;%= resource.node[prop] %>
      &lt;/p>
    &lt;%
  }
%>
&lt;/body>
&lt;/html></pre>

  <h2>Sling Javascript Templates (JST)</h2>
  <p>
  	If you prefer to waste your client's CPUs for rendering, JST templates use the same syntax as ESP, but generate
  	javascript rendering code that's executed on the client, and include in the response both a JSON version of the
  	data and a basic HTML rendering that is used for search engines, for example.
  </p>
  <p>
  	See <a href="https://issues.apache.org/jira/browse/SLING-114">SLING-114</a> for more info.
  </p>
  <p>
  	For now, here's a simplistic JST example. Make sure to have a look at what's sent to the browser!  
  </p>
  <pre>&lt;!-- Store this as html.jst in the appropriate scripts directory -->
  currentNode.title = &lt;b> &lt;%= currentNode.title %> &lt;/b>
&lt;/p>
&lt;p>
  currentNode.text = &lt;em> &lt;%= currentNode.text %> &lt;/em> (changed)
&lt;/p>

&lt;%
  // if present, this function is called by body.onLoad
  function onLoad() {
    document.title = currentNode.title;
  }
%></pre>
  
  <h2>Raw javascript</h2>
  <p>
  	Raw javascript is probably more useful to handle the POST, PUT or DELETE methods. To do that, name
  	the script after the method name, uppercased, i.e. <em>POST.js</em>.
  </p>
  
  <h3>Javascript example</h3>
    <pre>
// store this as html.js in the repository    
// TODO this is not very useful, rewrite this example
out.println("&lt;html>&lt;body>");
out.println("&lt;p>This page is generated from a rhino script&lt;/p>");
out.println("&lt;h1>" + resource.getPath() + "&lt;/h1>");
out.println("&lt;p>Title: " + resource.getNode().getProperty('title').getString() + "&lt;/p>");
out.println("&lt;p>Text: " + resource.getNode().getProperty('text').getString() + "&lt;/p>");
out.println("&lt;/body>&lt;/html>");</pre>
  </p>
  </div>
  
  <h2>Directory listing example</h2>
  <p>
    Store the following template under 
    <code>sling/scripts/nt/unstructured/html.esp</code> to render a simple
    directory listing for <em>nt:unstructured</em> nodes which do not have a 
    <code>slingComponentId</code> property.
  </p>
  <pre>
&lt;%-- ESP directory listing example -%>
&lt;html>
&lt;body>
&lt;p>This HTML directory listing is generated from an ESP template!&lt;/p>
&lt;h1>&lt;%= resource.uri %>&lt;/h1>
&lt;ol>
&lt;%
for (var prop in resource.node) {
    if (resource.node[prop]["text"]) {
        %>&lt;li>&lt;a href="/&lt;%= resource.node[prop] %>.html">&lt;%= resource.node[prop] %>&lt;/a>&lt;/li>&lt;%
    }
}
%>
&lt;/ol>
&lt;/body>
&lt;/html></pre>
  <p>
    If you have created some content with the test form, and activated the above template, 
    <a href="content/testing.html">content/testing.html</a> should
    display an HTML directory listing. 
  </p>
</body>
</html>