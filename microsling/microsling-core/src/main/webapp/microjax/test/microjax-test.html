<html>
	<!--
	   Licensed to the Apache Software Foundation (ASF) under one or more
	   contributor license agreements.  See the NOTICE file distributed with
	   this work for additional information regarding copyright ownership.
	   The ASF licenses this file to You under the Apache License, Version 2.0
	   (the "License"); you may not use this file except in compliance with
	   the License.  You may obtain a copy of the License at
	
	       http://www.apache.org/licenses/LICENSE-2.0
	
	   Unless required by applicable law or agreed to in writing, software
	   distributed under the License is distributed on an "AS IS" BASIS,
	   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	   See the License for the specific language governing permissions and
	   limitations under the License.
	  -->

	<head>
		<title>microjax test page</title>
		<link rel="stylesheet" type="text/css" href="../../microsling.css"/>
		<script src="../microjax.js"></script>
		<script src="assert.js"></script>
    
        <style type="text/css">
          .output {
            background-color: #FFFF99;
            border: solid black 1px;
            padding: 2px;
          }
        </style>
	</head>
	
	<body onLoad="runTests()">
 
	 <h1>Automated microjax tests</h1>
	 <p>
	   Loading this page executes some simple automated javascript tests of the microjax library.
	 </p>
	 
	 <h2>Test results</h2>
	 <p>
	 	If all goes well, the paragraph styled <span class="output">like this</span> below should say "Done running tests".
     </p>
     <p>
	 	Tests run quickly, this might have happened already.
	 </p>
	 <p>
	 	To run the tests again click <a href="javascript:runTests()">here</a>.
	 </p>
	 <div id="output" class="output" style="padding:1em">
	   Tests are not running yet.
	 </div>
	 
	 <h2>More info</h2>
	 <p>
	 	After running the tests at least once,
		<a href="/microjax-test/testhtml-nodes.json">/microjax-test/testhtml-nodes.json</a>
		should show the JSON data of the nodes created by the test cases.
	 </p>
	 <p>
	 	See the source code of this page for details.
	 </p>
	   
 
	<script language="javascript">
	  function microjaxPost(url,params) {
	    var httpcon = microjax.getXHR();
	    httpcon.open("POST", url, false);
	    httpcon.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	    httpcon.setRequestHeader("Content-length", params.length);
	    httpcon.setRequestHeader("Connection", "close");
	    httpcon.send(params);
	    return httpcon;
	  }
	  
	  var now = new Date().getTime();
	  var testPath = "/microjax-test/testhtml-nodes/test-" + now;
	  
	  function testPost() {
	    var c = microjaxPost(testPath,"title=hello&created=&dummy=&time=" + now);
	    assert("Expected 200 status for POST",c.status == 200);
	  }
	  
	  function verifyPostedElement() {
	    var data = microjax.getContent(testPath,1);
	    assertNotNull("data",data);
	    assertEquals("title matches","hello",data.title);
	    assertEquals("time matches",now,data.time);
	    assertEquals("created property is a string","string",typeof(data.created));
        // TODO implement 'created' autoset property
	    // assert("created property is not empty",data.created.length > 0);
	    assertEquals("dummy property is a string","string",typeof(data.dummy));
	    assert("dummy property is empty",data.dummy.length == 0);
	  }
	  
	  function testGetSessionInfo() {
	    var session = microjax.getSessionInfo();
	    assertEquals("session.userID is a string","string",typeof(session.userID));
        assertEquals("session.userID == 'admin'","admin",session.userID);
	    assertEquals("session.workspace is a string","string",typeof(session.workspace));
	    assert("session.workspace contains 'default'",session.workspace.indexOf('default') >= 0);
	  }
	  
	  function testRemoveContent() {
		var deletePath = "/microjax-test/testhtml-nodes/delete-" + now;
	    var c = microjaxPost(deletePath,"title=hello&created=&dummy=&time=" + now);
	    assert("Expected 200 status for POST",c.status == 200);
	    
	    var data = microjax.getContent(deletePath,1);
	    assertNotNull("data must be found before removeContent",data);
	    
	    var d = microjax.removeContent(deletePath);
	    assert("Expected 200 status for removeContent, got " + d.status,d.status == 200);
	    data = microjax.getContent(deletePath,1);
	    assertNull("data should be gone after deletePath",data);
	  }
	  
	  function runTests() {
	    var out = document.getElementById("output");
	    out.innerHTML = "Tests are running...";
	    assert(null,2 + 2 == 4);
	    testPost();
	    verifyPostedElement();
	    testGetSessionInfo();
	    testRemoveContent();
	    out.innerHTML = "<b>Done running tests, at " + new Date() + "</b>";
	  }
	</script>
  
 </body>
</html>
